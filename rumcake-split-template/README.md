# rumcake-template

<!--toc:start-->
  - [About](#about)
    - [memory.x](#memoryx)
  - [Toolchain requirements](#toolchain-requirements)
    - [Target](#target)
  - [Building and Flashing](#building-and-flashing)
    - [With a probe (e.g. ST-LINK or J-LINK)](#with-a-probe-eg-st-link-or-j-link)
    - [Without a probe](#without-a-probe)
<!--toc:end-->

## About

This template builds a firmware for a split keyboard that has:

- Bluetooth host communication (using the left half)
- nRF52840 MCU on both halves (tested with nice!nano v2)

### memory.x

Note that `memory.x` contains values that correspond to an nRF52840 that has softdevice S140 6.1.1.
If your MCU has a different softdevice on it, you may need to change these values.

See the [nrf-softdevice repo](https://github.com/embassy-rs/nrf-softdevice) for more details.

## Toolchain requirements

This template assumes that you have `rustup` and `cargo` available in your `$PATH`, and that you have the latest `nightly` Rust toolchain.

### Target

Since this keyboard uses an nRF52840, we need to add the `thumbv7em-none-eabihf` target to our rust toolchain.

```bash
rustup target add thumbv7em-none-eabihf
```

## Building and Flashing

The following instructions are specific to this MCU (nRF52840).

Note that `.cargo/config.toml` specifies `thumbv7em-none-eabihf` as our build target.

### With a probe (e.g. ST-LINK or J-LINK)

If you have a probe, make sure you [install probe-run](https://probe.rs/docs/getting-started/installation/).

To build and flash the left half, call `cargo run` with the required features (specified in the `Cargo.toml`).

```bash
cargo run --bin left --release --features "rumcake/split-central rumcake/bluetooth rumcake/usb"
```

Similarly with the right side:

```bash
cargo run --bin right --release --features "rumcake/split-peripheral"
```

### Without a probe

Using [elf2uf2-rs](https://github.com/simmsb/elf2uf2-rs), we can convert the ELF binary generated by the build to a UF2 file that can be flashed directly to the MCU.

After `build.sh` you'll have the ELF binary in `target/thumbv7em-none-eabihf/release/left` and `target/thumbv7em-none-eabihf/release/right`.

To install the left half:

```bash
    # convert the ELF binary to UF2
    elf2uf2-rs target/thumbv7em-none-eabihf/release/left left.uf2

    # copy the UF2 file to the MCU folder
    sudo cp left.uf2 ${MCU_FOLDER}
```

To install the right half:

```bash
    # convert the ELF binary to UF2
    elf2uf2-rs target/thumbv7em-none-eabihf/release/right right.uf2

    # copy the UF2 file to the MCU folder
    sudo cp right.uf2 ${MCU_FOLDER}
```

You'll find your `MCU_FOLDER` with `lsblk` and checking after plugging in the MCU.

NOTE: at the time of writing this was only tested with just the `usb` feature enabled.
As soon as the `bluetooth` feature is enabled the keyboard stops working.
